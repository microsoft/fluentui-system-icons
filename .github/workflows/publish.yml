name: Publish library

on:
  push:
    branches: [ master ]

env:
  LIBRARY_VERSION: 1.1.${{ github.run_number }}

jobs:
  publish-library:
    name: Publish mobile libraries
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Bump version patch
      run: |
        grep -E "[0-9]+\.[0-9]+\.[0-9]+" FluentIcons.podspec |
            python3 -c """
        import sys
        current_version = sys.stdin.read().strip().split(\"'\")[1]
        major, minor, patch = current_version.split('.')
        print(f'::set-env name=NEW_VERSION::{major}.{minor}.{int(patch) + 1}')
        """

    - name: Use Node 11
      uses: actions/setup-node@v1
      with:
        node-version: 11.x

    - run: npm install
      working-directory: importer

    ## iOS
    - name: Run iOS generate script
      run: npm run deploy:ios
      working-directory: importer

    ## Android
    - name: Run Android generate script
      run: npm run deploy:android
      working-directory: importer

    - name: Setup Java
      uses: actions/setup-java@v1
      with:
        java-version: 8

    - name: Build and publish Android library
      uses: eskatos/gradle-command-action@v1
      with:
        arguments: bintrayUpload -DversionName=${{ env.NEW_VERSION }} -DbintrayUser=${{ secrets.BINTRAY_USER }} -DbintrayKey=${{ secrets.BINTRAY_KEY }}
        build-root-directory: android
        wrapper-directory: android

    ## Publish
    # Needs to be "-E" instead of "-r" on macOS
    - name: Replace version numbers in README.md
      run: |
        sed -i.bk -r "s/[0-9]+\.[0-9]+\.[0-9]+/$LIBRARY_VERSION/g" README.md
        rm README.md.bk

    # Needs to be "-E" instead of "-r" on macOS
    - name: Replace version numbers in ios/README.md
      run: |
        sed -i.bk -r "s/[0-9]+\.[0-9]+\.[0-9]+/$LIBRARY_VERSION/g" ios/README.md
        rm ios/README.md.bk

    # Needs to be "-E" instead of "-r" on macOS
    - name: Replace version number in Podspec
      run: |
        sed -i.bk -r "s/[0-9]+\.[0-9]+\.[0-9]+/$LIBRARY_VERSION/g" ios/FluentIcons.podspec
        rm ios/FluentIcons.podspec.bk

    - name: Update icon sheet
      run: python3 generate_icons_md.py

    - name: Config git credentials
      run: git config user.email "flubuild@microsoft.com" && git config user.name "Fluent Build System"

    - name: Commit version number change
      run: |
        git add -A
        git commit -m "Release $LIBRARY_VERSION"

    - name: Tag release
      run: git tag "$LIBRARY_VERSION"

    - name: Push release
      run: |
        REMOTE_REPO="https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
        git push $REMOTE_REPO HEAD:master --follow-tags --tags

  publish-android-demo:
    name: Publish Android demo app
    runs-on: ubuntu-latest
    needs: publish-library

    steps:
    - uses: actions/checkout@v2

    - name: Use Node 11
      uses: actions/setup-node@v1
      with:
        node-version: 11.x

    - run: npm install
      working-directory: importer

    - name: Run generate script
      run: npm run deploy:android
      working-directory: importer

    - name: Setup Java
      uses: actions/setup-java@v1
      with:
        java-version: 8

    - name: Restore release keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE }}" > release.keystore.asc
        gpg -d --passphase "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" --batch release.keystore.asc > release.keystore

    # # https://github.com/marketplace/actions/gradle-command
    # - name: Build Android demo app
    #   uses: eskatos/gradle-command-action@v1
    #   with:
    #     options: '-DversionName=$LIBRARY_VERSION -DversionCode=$LIBRARY_VERSION -Pandroid.injected.signing.store.file=release.keystore -Pandroid.injected.signing.store.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} -Pandroid.injected.signing.key.alias=${{ secrets.ANDROID_KEYSTORE_ALIAS }} -Pandroid.injected.signing.key.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}'
    #     arguments: ':sample-showcase:assembleRelease'
    #     build-root-directory: android
    #     wrapper-directory: android

    # TODO
    # https://github.com/marketplace/actions/app-center
    # - name: Publish apk to App Center
    #   uses: wzieba/AppCenter-Github-Action@v1.0.0
    #   with:
    #     appName: ${{secrets.APP_CENTER_DEMO_APP_NAME}}
    #     token: ${{secrets.APP_CENTER_TOKEN}}
    #     group: Public
    #     file: android/sample-showcase/build/outputs/apk/release/sample-showcase-release.apk
    #     gitReleaseNotes: true
